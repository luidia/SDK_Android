package com.pnf.pen.test;

import java.util.List;
import java.util.Timer;
import java.util.TimerTask;

import com.pnf.bt.lib.PNFDefine;
import com.pnf.bt.lib.PenDataClass;
import com.pnf.pen.calibration.CalibrationPointActivity;
import com.pnf.pen.dataimport.DataImportActivity;
import com.pnf.pen.drawingview.DrawViewActivity;

import android.annotation.SuppressLint;
import android.app.Activity;
import android.app.AlertDialog;
import android.content.Context;
import android.content.DialogInterface;
import android.content.Intent;
import android.graphics.PointF;
import android.graphics.RectF;
import android.os.Bundle;
import android.os.Handler;
import android.os.Message;
import android.os.PowerManager;
import android.view.KeyEvent;
import android.view.View;
import android.view.ViewStub;
import android.widget.ScrollView;
import android.widget.TextView;
import android.widget.Toast;

public class MainActivity extends Activity {
	PowerManager.WakeLock mWakeLock;
	
	final byte SLEEPVIEW_SHOWPOPUP = 0x00;
	final byte SLEEPVIEW_CLOSEPOPUP = 0x01;
	final byte SLEEPVIEW_STARTPOPUP = 0x02;
	
	final byte REQUEST_DRAWVIEW = 0x00;
	final byte REQUEST_CALIBRATIONVIEW = 0x01;
	final byte REQUEST_TIMETESTVIEW = 0x02;
	final byte REQUEST_THRESHOLDVIEW = 0x03;
	
	final byte ALERTVIEW_FAIL_LISTENING = 0x00;
	final byte ALERTVIEW_APP_EXIT = 0x01;
	
	final byte SHOWPOPUP_PEN_CONNECT = 0x00;
	final byte SHOWPOPUP_PEN_DISCONNECT = 0x01;
	final byte SHOWPOPUP_PEN_ALIVE = 0x02;
	
	ScrollView writeLogScrollView;
	TextView writeLogTextView;

	TextView modelCodeValueTextView;
	TextView hwVerValueTextView;
	TextView mcu1VerValueTextView;
	TextView aliveSecValueTextView;
	TextView mcu2VerValueTextView;
	TextView temperatureValueTextView;
	TextView packetCountValueTextView;
	TextView errXCntValueTextView;
	TextView errYCntValueTextView;
	TextView pressureValueTextView;
	TextView curThresholdValueTextView;
	TextView statusValueTextView;
	TextView rawXValueTextView;
	TextView rawYValueTextView;
	TextView convXValueTextView;
	TextView convYValueTextView;
	TextView smartMakerValueTextView;
	
	TextView downCountValueTextView;
	TextView moveCountValueTextView;
	TextView upCountValueTextView;
	TextView totalCountValueTextView;
	TextView kbyteValueTextView;
	TextView byteValueTextView;
	
	View penSleepView;
	
	boolean isCheckSleepView = false;
	final int penSleepDelay = 600;
	int savePenSleepRemainingTime;
	int savePenAliveSec;
	int curPenAliveSec;
	int penCheckAliveCnt;
	
	Timer penAliveTimer = null;
	
	int diFileCount = 0;
	int penErrorCnt = 0;
	int packetCnt = 0;
	int downCnt = 0;
	int moveCnt = 0;
	int upCnt = 0;
	int errCntX = 0;
	int errCntY = 0;
	int beforeRawX = -1;
	int beforeRawY = -1;
	
	boolean isHasFocus = false;
	
	@Override
	protected void onResume() {
		super.onResume();
		
		MainDefine.penController.SetRetObj(penHandler);
		MainDefine.penController.SetRetObjForEnv(PenHandlerEnv);
		MainDefine.penController.SetRetObjForMsg(messageHandler);
	}

	@Override
	protected void onPause() {
		super.onPause();
	}

	@Override
	public void onDestroy() {
		super.onDestroy();
		
		stopPenAliveTimer();
	}

	@Override
	protected void onUserLeaveHint() {
		super.onUserLeaveHint();
	}
	
	
	@Override
    public void onWindowFocusChanged(boolean hasFocus) {
		isHasFocus = hasFocus;
    }

	@Override
	public void onBackPressed()
	{
		
		if(penSleepView.getVisibility() == View.VISIBLE){
			penSleepBtnClicked(null);
			return;
		}
		
		showAlertView(ALERTVIEW_APP_EXIT);
		return;
	}

	@Override
	public boolean onKeyDown(int keyCode, KeyEvent event) 
	{
		if(keyCode == KeyEvent.KEYCODE_MENU){
			return true;
		}

		return super.onKeyDown(keyCode, event);
	}
	
	@Override
	public void onActivityResult(int requestCode, int resultCode, Intent data) 
	{
		boolean isResultOK = resultCode == Activity.RESULT_OK?true:false;
		String debugStr = "";
		
		switch(requestCode)
		{
		case REQUEST_DRAWVIEW:
			if(isResultOK){
				debugStr = data.getExtras().getString("debug");
				addDebugText(debugStr);
			}
			break;
		case REQUEST_CALIBRATIONVIEW:
			if(isResultOK){
				debugStr = data.getExtras().getString("debug");
				addDebugText(debugStr);
			}
			break;
		case REQUEST_TIMETESTVIEW:
			break;
		case REQUEST_THRESHOLDVIEW:
			break;
		}
	}
	
    @SuppressLint("Wakelock")
	@SuppressWarnings("deprecation")
	@Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        
        writeLogScrollView = (ScrollView) findViewById(R.id.writeLogScrollView);
        writeLogTextView = (TextView) findViewById(R.id.writeLogTextView);

    	modelCodeValueTextView = (TextView) findViewById(R.id.modelCodeValueTextView);
    	hwVerValueTextView = (TextView) findViewById(R.id.hwVerValueTextView);
    	mcu1VerValueTextView = (TextView) findViewById(R.id.mcu1VerValueTextView);
    	aliveSecValueTextView = (TextView) findViewById(R.id.aliveSecValueTextView);
    	mcu2VerValueTextView = (TextView) findViewById(R.id.mcu2VerValueTextView);
    	temperatureValueTextView = (TextView) findViewById(R.id.temperatureValueTextView);
    	packetCountValueTextView = (TextView) findViewById(R.id.packetCountValueTextView);
    	errXCntValueTextView = (TextView) findViewById(R.id.errXCntValueTextView);
    	errYCntValueTextView = (TextView) findViewById(R.id.errYCntValueTextView);
    	pressureValueTextView = (TextView) findViewById(R.id.pressureValueTextView);
    	curThresholdValueTextView = (TextView) findViewById(R.id.curThresholdValueTextView);
    	statusValueTextView = (TextView) findViewById(R.id.statusValueTextView);
    	rawXValueTextView = (TextView) findViewById(R.id.rawXValueTextView);
    	rawYValueTextView = (TextView) findViewById(R.id.rawYValueTextView);
    	convXValueTextView = (TextView) findViewById(R.id.convXValueTextView);
    	convYValueTextView = (TextView) findViewById(R.id.convYValueTextView);
    	
    	downCountValueTextView = (TextView) findViewById(R.id.downCountValueTextView);
    	moveCountValueTextView = (TextView) findViewById(R.id.moveCountValueTextView);
    	upCountValueTextView = (TextView) findViewById(R.id.upCountValueTextView);
    	totalCountValueTextView = (TextView) findViewById(R.id.totalCountValueTextView);
    	kbyteValueTextView = (TextView) findViewById(R.id.kbyteValueTextView);
    	byteValueTextView = (TextView) findViewById(R.id.byteValueTextView);
    	smartMakerValueTextView = (TextView) findViewById(R.id.smartMakerValueTextView);
    	
    	penSleepView = ((ViewStub) findViewById(R.id.penSleepStub)).inflate();
    	
    	penSleepView.setVisibility(View.GONE);
    	isCheckSleepView = true;
    	
    	PowerManager powerManager = (PowerManager)getSystemService(Context.POWER_SERVICE);
		mWakeLock = powerManager.newWakeLock(PowerManager.SCREEN_DIM_WAKE_LOCK | PowerManager.ON_AFTER_RELEASE, "My Tag");
		mWakeLock.acquire();
    }
    
    /*
     * top 1 menu button
     */
    public void drawingBtnClicked(View v){
    	Intent intent = new Intent(MainActivity.this, DrawViewActivity.class);
		startActivityForResult(intent, REQUEST_DRAWVIEW);
    }
    
    public void calibrationBtnClicked(View v){
    	
    	if(MainDefine.penController.getExistCaliData()){
    		addDebugText("calibration data exist");
    	}else{
    		addDebugText("calibration data not exist");
    	}
    	
    	if (MainDefine.penController.getModelCode() == 0) {
            addDebugText("smart pen");
        }
        else if (MainDefine.penController.getModelCode() == 1) {
        	addDebugText("lollol pen");
        }
        else if (MainDefine.penController.getModelCode() == 2) {
        	addDebugText("Equil SmartPen");
        }
        else if (MainDefine.penController.getModelCode() == 3) {
        	addDebugText("Equil SmartPen2");
        }
        else if (MainDefine.penController.getModelCode() == 4) {
        	addDebugText("Smart Maker");
        }
    	
    	Intent intent = new Intent(MainActivity.this, CalibrationPointActivity.class);
		startActivityForResult(intent, REQUEST_CALIBRATIONVIEW);
    }
    
    public void stopPenBtnClicked(View v){
    	MainDefine.penController.stopPen();
    }
    
    public void restartPenBtnClicked(View v){
    	MainDefine.penController.restartPen();
    }
    
    public void clearLogBtnClicked(View v){
    	writeLogTextView.setText("");
    }
    
    public void DIClicked(View v){
    	if(MainDefine.penController.isPenMode())
    	{
    		if(diFileCount > 0){
    			Intent intent = new Intent(MainActivity.this, DataImportActivity.class);
        		startActivity(intent);
    		}
    	}
    }
    
    public void packetCountClearClicked(View v){
    	packetCnt = 0;
        errCntX = 0;
        errCntY = 0;
        beforeRawX = -1;
        beforeRawY = -1;
        
        updateErrCntX();
        updateErrCntY();
        updatePacketCnt();
    }
    
    public void countClearClicked(View v){
    	downCnt = 0;
        moveCnt= 0;
        upCnt = 0;
        
        updateDrawCnt();
    }
    
    public void penSleepBtnClicked(View v){
		penPopupHandler.sendEmptyMessage(SLEEPVIEW_CLOSEPOPUP);
	}
    
    void showAlertView(int alertTag){
    	AlertDialog.Builder builder = null;
    	AlertDialog alert = null;
    	
    	builder = new AlertDialog.Builder(MainActivity.this);
    	builder.setCancelable(false);
    	
    	switch(alertTag)
    	{
    	case ALERTVIEW_FAIL_LISTENING:
    		builder.setTitle(getResources().getString(R.string.FAIL_LISTENING_MSG));
        	builder.setPositiveButton(getResources().getString(R.string.COMMON_OK), new DialogInterface.OnClickListener() {
        		public void onClick(DialogInterface dialog, int which) {
        			dialog.dismiss();
        		}
        	});
        	builder.setNegativeButton(getResources().getString(R.string.COMMON_CANCEL), new DialogInterface.OnClickListener() {
        		public void onClick(DialogInterface dialog, int which) {
        			dialog.dismiss();
        		}
        	});
    		break;
    	case ALERTVIEW_APP_EXIT:
    		builder.setTitle(getResources().getString(R.string.QUIL_APP));
        	builder.setPositiveButton(getResources().getString(R.string.COMMON_OK), new DialogInterface.OnClickListener() {
        		public void onClick(DialogInterface dialog, int which) {
        			dialog.dismiss();
        			
        			setResult(RESULT_OK ,null);
        			finish();
        		}
        	});
        	builder.setNegativeButton(getResources().getString(R.string.COMMON_CANCEL), new DialogInterface.OnClickListener() {
        		public void onClick(DialogInterface dialog, int which) {
        			dialog.dismiss();
        		}
        	});
    		break;
    	}
    	
    	alert = builder.create();
    	alert.show();
	}
    
    void updateErrCntX(){
    	errXCntValueTextView.setText(""+errCntX);
    }
    
    void updateErrCntY(){
    	errYCntValueTextView.setText(""+errCntY);
    }
    
    void updatePacketCnt(){
    	packetCountValueTextView.setText(""+packetCnt);
    }
    
    void updateDrawCnt(){
    	downCountValueTextView.setText(""+downCnt);
    	moveCountValueTextView.setText(""+moveCnt);
    	upCountValueTextView.setText(""+upCnt);
    	totalCountValueTextView.setText(""+(downCnt+moveCnt+upCnt));
    	
    	float byteData = 0;
        if (downCnt+moveCnt+upCnt == 0)
        	byteValueTextView.setText("0");
        else {
            byteValueTextView.setText(""+(((downCnt+moveCnt+upCnt)*6)+((downCnt+moveCnt+upCnt)/12)+1));
            byteData = ((downCnt+moveCnt+upCnt)*6)+((downCnt+moveCnt+upCnt)/12)+1;
        }
        kbyteValueTextView.setText(""+(byteData/1024.f));
    }
    
    void addDebugText(String text) {
    	String orgText = writeLogTextView.getText().toString();
    	String inputText = "";
    	if(orgText.isEmpty()){
    		inputText = text;
    	}else{
    		inputText = orgText + "\n" + text;
    	}
    	
    	writeLogTextView.setText(inputText);
    	writeLogScrollView.post(new Runnable() {       
    		@Override
    		public void run() {
    			writeLogScrollView.fullScroll(View.FOCUS_DOWN);              
    		}
    	});

    }
    
    @SuppressLint("HandlerLeak")
	Handler penHandler = new Handler() 
	{        
		@Override
		public void handleMessage(Message msg) 
		{
			onPenEvent(msg.what ,msg.arg1 ,msg.arg2 ,msg.obj);
		}
	};
	
	void onPenEvent(int penState, int RawX, int RawY ,Object obj)
	{
		penPopupHandler.sendEmptyMessage(SLEEPVIEW_STARTPOPUP);
		
		if (MainDefine.penController == null) {
	        addDebugText("PenController is not set");
	        return;
	    }
		
		PenDataClass penData = (PenDataClass)obj;
		PointF ptConv = MainDefine.penController.GetCoordinatePostionXY(RawX ,RawY ,penData.bRight);
		int penTemperature = penData.Pen_Temperature;
		int penPressure = penData.Pen_Pressure;
		
		packetCnt++;
		
		updatePacketCnt();
		
		statusValueTextView.setText(""+penState);
		temperatureValueTextView.setText(""+penTemperature);
		pressureValueTextView.setText(""+penPressure);
		rawXValueTextView.setText(""+RawX);
		rawYValueTextView.setText(""+RawY);
		convXValueTextView.setText(""+ptConv.x);
		convYValueTextView.setText(""+ptConv.y);
		
		/*
		 * MARKER PEN STATE
		 */
		if(MainDefine.penController.getModelCode() == 4){
			switch(penData.MakerPenStatus){
			case PNFDefine.MARKERPEN_RED_MARKER:
				smartMakerValueTextView.setText("RED");
				break;
			case PNFDefine.MARKERPEN_GREEN_MARKER:
				smartMakerValueTextView.setText("GREEN");
				break;
			case PNFDefine.MARKERPEN_YELLOW_MARKER:
				smartMakerValueTextView.setText("YELLOW");
				break;
			case PNFDefine.MARKERPEN_BLUE_MARKER:
				smartMakerValueTextView.setText("BLUE");
				break;
			case PNFDefine.MARKERPEN_PURPLE_MARKER:
				smartMakerValueTextView.setText("PURPLE");
				break;
			case PNFDefine.MARKERPEN_BLACK_MARKER:
				smartMakerValueTextView.setText("BLACK");
				break;
			case PNFDefine.MARKERPEN_ERASER_CAP:
				smartMakerValueTextView.setText("ERASER CAP");
				break;
			case PNFDefine.MARKERPEN_LOW_BATTERY:
				smartMakerValueTextView.setText("LOW BATTERY");
				break;
			case PNFDefine.MARKERPEN_BIG_ERASER:
				smartMakerValueTextView.setText("BIG ERASER");
				break;
			}
		}
		
		switch(penState)
		{	
		case PNFDefine.PEN_DOWN:
			downCnt++;
//			addDebugText("RawX = " + RawX + "	RawY = " + RawY);
			break;
		case PNFDefine.PEN_MOVE:
			moveCnt++;
			break;
		case PNFDefine.PEN_UP:
			upCnt++;
			break;
			
			
		case PNFDefine.PEN_HOVER:
			break;
		case PNFDefine.PEN_HOVER_DOWN:
			break;
		case PNFDefine.PEN_HOVER_MOVE:
			break;
		}
		
		updateDrawCnt();
		
		if (beforeRawX == -1) {
	        beforeRawX = RawX;
	    }
	    else {
	        if (RawX-beforeRawX>1.0f) {
	            errCntX++;
	            updateErrCntX();
	        }
	    }
	    if (beforeRawY == -1) {
	        beforeRawY = RawY;
	    }
	    else {
	        if (RawY-beforeRawY>1.0f) {
	            errCntY++;
	            updateErrCntY();
	        }
	    }
	}
	
	@SuppressLint("HandlerLeak")
	Handler PenHandlerEnv = new Handler() 
	{        
		@Override
		public void handleMessage(Message msg) 
		{
			onPenEnvEvent(msg.what ,msg.obj);
		}
	};
	
	void onPenEnvEvent(int what ,Object obj)
	{
		if(obj == null) return;		
		
		switch(what)
		{
		case PNFDefine.PNF_MSG_ENV_DATA:
			PenDataClass penData = (PenDataClass)obj;
			
			curPenAliveSec = penData.Pen_Alive;
//			int Pen_Station_Battery = (int) penData.Pen_Station_Battery;
//			int Pen_Battery = (int) penData.Pen_Battery;
			
			if(curPenAliveSec > 0){
				if(penSleepView.getVisibility() == View.VISIBLE){
					penSleepView.setVisibility(View.GONE);
				}
			}
			
			if(isCheckSleepView){
				if(penAliveTimer == null) {
			        penAliveTimer = new Timer();
			        TimerTask penAliveTask = new TimerTask() {
						@Override
						public void run() {
							onTimerForPenAlive();
						}
					};
					penAliveTimer.schedule(penAliveTask, 1000 ,1000);
					
			        savePenSleepRemainingTime = (int) MainDefine.GetCurrentSec() + penSleepDelay;
			        savePenAliveSec = penSleepDelay;
			        curPenAliveSec = penSleepDelay;
			    }
			}
			break;
		case PNFDefine.PEN_DI_TEMPLETE:
//			penDataArray = (ArrayList<PenDataClass>)obj;
			break;
		case PNFDefine.PEN_DI_DELETE:
			addDebugText("PEN_DI_DELETE");
//			penDataArray = (ArrayList<PenDataClass>)obj;
			break;
		default:
			break;
		}
	}
	
	void onTimerForPenAlive(){
		int curTime = (int) MainDefine.GetCurrentSec();
		
		boolean check = false;
		if(MainDefine.penController.getModelCode() == 2){
			if(MainDefine.penController.getMCU1() >= 2 && MainDefine.penController.getMCU2() >= 2 && MainDefine.penController.getHWVersion() >= 2){
				check = true;
			}
		}else if(MainDefine.penController.getModelCode() == 3){
			if(MainDefine.penController.getMCU1() >= 1 && MainDefine.penController.getMCU2() >= 1 && MainDefine.penController.getHWVersion() >= 1){
				check = true;
			}
		}
		
		if(check){
			if(curPenAliveSec <= 0) {
				penPopupHandler.sendEmptyMessage(SLEEPVIEW_SHOWPOPUP);
				return;
			}else{
				penCheckAliveCnt = 0;
			}
			
			
			if(curPenAliveSec != 0){
				if(savePenAliveSec != curPenAliveSec){
					savePenAliveSec = curPenAliveSec;
					savePenSleepRemainingTime = (int) curTime+curPenAliveSec;
				}
			}
		}
		
		if(savePenSleepRemainingTime - curTime < 0) {
			penPopupHandler.sendEmptyMessage(SLEEPVIEW_SHOWPOPUP);
		}else{
			penCheckAliveCnt = 0;
		}
	}
	
	void stopPenAliveTimer(){
		isCheckSleepView = false;
		
		if(penAliveTimer != null){
    		penAliveTimer.cancel();
			penAliveTimer.purge();
			penAliveTimer = null;
    	}
	}
	
	@SuppressLint("HandlerLeak")
	Handler penPopupHandler = new Handler() 
	{        
		@Override
		public void handleMessage(Message msg) 
		{
			switch(msg.what)
			{
			case SLEEPVIEW_SHOWPOPUP://슬핍 팝업창 호출
				if(++penCheckAliveCnt > 10){
					if(penSleepView.getVisibility() == View.GONE){
						penSleepView.setVisibility(View.VISIBLE);
					}
					
					stopPenAliveTimer();
				}
				break;
			case SLEEPVIEW_CLOSEPOPUP://X버튼으로 강제 닫기
				if(penSleepView.getVisibility() == View.VISIBLE){
					penSleepView.setVisibility(View.GONE);
				}
				
				stopPenAliveTimer();
				break;
			case SLEEPVIEW_STARTPOPUP://펜 입력으로 닫기
				if(penSleepView.getVisibility() == View.VISIBLE){
					penSleepView.setVisibility(View.GONE);
				}
				
				isCheckSleepView = true;
				if(curPenAliveSec != penSleepDelay){
					savePenSleepRemainingTime = (int) MainDefine.GetCurrentSec() + penSleepDelay;
			        savePenAliveSec = penSleepDelay;
			        curPenAliveSec = penSleepDelay;
				}
				break;
			}
		}
	};
	
	@SuppressLint("HandlerLeak")
	Handler messageHandler = new Handler() 
	{        
		@Override
		public void handleMessage(Message msg) 
		{
			onMessageEvent(msg.what ,msg.obj);
		}
	};
	
	void onMessageEvent(int what ,Object obj)
	{
		if(what == PNFDefine.PNF_MSG_FAIL_LISTENING){
//			showAlertView(ALERTVIEW_FAIL_LISTENING);
			addDebugText("PNF_MSG_FAIL_LISTENING");
			return;
		}else if(what == PNFDefine.PNF_MSG_CONNECTED){
			addDebugText("PNF_MSG_CONNECTED");
			
			diFileCount = 0;
			penErrorCnt = 0;
		}
		
		if(what == PNFDefine.PNF_MSG_INVALID_PROTOCOL){
			return;
		}
		
		else if(what == PNFDefine.PNF_MSG_SESSION_CLOSED){
			addDebugText("PNF_MSG_SESSION_CLOSED");
		}
		else if(what == PNFDefine.PNF_MSG_PEN_RMD_ERROR){
			penErrorCnt++;
			if (penErrorCnt > 5) {
				Toast.makeText(
						getApplicationContext(),
						MainDefine.getLangString(getApplicationContext() ,R.string.PEN_RMD_ERROR_MSG),
						Toast.LENGTH_SHORT)
					.show();
				penErrorCnt = 0;
			}
			return;
		}
		else if(what == PNFDefine.PNF_MSG_DI_TEMP_FILE_COMPLETE)
		{
			addDebugText("PNF_MSG_DI_TEMP_FILE_COMPLETE");
			MainDefine.penController.setDIState(1);
		}
		else if(what == PNFDefine.PNF_MSG_FIRST_DATA_RECV){
			addDebugText("PNF_MSG_FIRST_DATA_RECV");
			
			if(MainDefine.penController.getModelCode() == 4){
				RectF rectFT_8X5 = new RectF(
						 1810, 44163 ,
						20164, 55938);
				
				PointF[] calScreenPoint = new PointF[4];
	        	PointF[] calResultPoint = new PointF[4];
	        	calResultPoint[0] = new PointF(rectFT_8X5.left, rectFT_8X5.top);
	            calResultPoint[1] = new PointF(rectFT_8X5.right, rectFT_8X5.top);
	            calResultPoint[2] = new PointF(rectFT_8X5.right ,rectFT_8X5.bottom);
	            calResultPoint[3] = new PointF(rectFT_8X5.left ,rectFT_8X5.bottom);
	            
	            calScreenPoint[0] = new PointF(0.0f ,0.0f);
	            calScreenPoint[1] = new PointF(MainDefine.iDisGetWidth ,0.0f);
	            calScreenPoint[2] = new PointF(MainDefine.iDisGetWidth ,MainDefine.iDisGetHeight);
	            calScreenPoint[3] = new PointF(0.0f ,MainDefine.iDisGetHeight);
	            
	            MainDefine.penController.setCalibrationData(calScreenPoint, 0, calResultPoint);
			}
		}
		else if(what == PNFDefine.PNF_MSG_DI_START){
			addDebugText("PNF_MSG_DI_START");
		}
		else if(what == PNFDefine.PNF_MSG_DI_STOP){
			addDebugText("PNF_MSG_DI_STOP");
		}
		else if(what == PNFDefine.PNF_MSG_DI_OK){
			addDebugText("PNF_MSG_DI_OK");
		}
		else if(what == PNFDefine.PNF_MSG_DI_FAIL){
			addDebugText("PNF_MSG_DI_FAIL");
		}
		else if(what == PNFDefine.PNF_MSG_DI_FILE_LIST_COMPLETE){
			addDebugText("PNF_MSG_DI_FILE_LIST_COMPLETE");
			
			diFileCount = 0;
			List<String> folderNameList = MainDefine.penController.getDIFolderName();
			if(folderNameList != null && folderNameList.size() > 0){
				for(String folderName : folderNameList){
					List<String> fileNameList = MainDefine.penController.getDIFileName(folderName);
					
					diFileCount += fileNameList.size();
				}
			}
			
			if(diFileCount > 0){
				addDebugText("Station has " + String.valueOf(diFileCount) + " file(s).");
			}
		}else if(what == PNFDefine.GESTURE_CIRCLE_CLOCKWISE){
			addDebugText("GESTURE_CIRCLE_CLOCKWISE");
			return;
		}
		else if(what == PNFDefine.GESTURE_CIRCLE_COUNTERCLOCKWISE){
			addDebugText("GESTURE_CIRCLE_COUNTERCLOCKWISE");
			return;
		}
		else if(what == PNFDefine.GESTURE_CLICK){
			addDebugText("GESTURE_CLICK");
			return;
		}
		else if(what == PNFDefine.GESTURE_DOUBLECLICK){
			addDebugText("GESTURE_DOUBLECLICK");
			return;
		}
		
		packetCnt++;
	    updatePacketCnt();
	    
	    modelCodeValueTextView.setText(""+MainDefine.penController.getModelCode());
		mcu1VerValueTextView.setText(""+MainDefine.penController.getMCU1());
		mcu2VerValueTextView.setText(""+MainDefine.penController.getMCU2());
		hwVerValueTextView.setText(""+MainDefine.penController.getHWVersion());
	}
	
}
